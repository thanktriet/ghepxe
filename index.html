<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kho Xe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .container { max-width: 1600px; margin-left: auto; margin-right: auto; padding: 20px; }
        .card { background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 24px; margin-bottom: 24px; }
        input[type="text"], input[type="number"], input[type="password"], input[type="date"], select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-top: 4px; margin-bottom: 16px; box-sizing: border-box; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, input[type="date"]:focus, select:focus, textarea:focus { border-color: #4f46e5; outline: none; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }
        label { display: block; margin-bottom: 2px; font-weight: 500; color: #374151; }
        button { padding: 10px 20px; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; display: inline-flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: #4f46e5; color: #ffffff; border: 1px solid #4f46e5; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-danger { background-color: #ef4444; color: #ffffff; border: 1px solid #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-outline { background-color: transparent; color: #4f46e5; border: 1px solid #4f46e5; }
        .btn-outline:hover { background-color: #e0e7ff; }
        .btn-secondary { background-color: #6b7280; color: #ffffff; border: 1px solid #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .tab-button { padding: 12px 24px; border-radius: 0.5rem 0.5rem 0 0; background-color: transparent; color: #4b5563; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; margin-right: 8px; }
        .tab-button.active { color: #4f46e5; border-bottom: 3px solid #4f46e5; background-color: #ffffff; }
        .table-container { overflow-x: auto; background-color: #fff; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; text-transform: uppercase; font-size: 0.8rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f0f9ff; }
        .message-box { position: fixed; top: 20px; right: 20px; padding: 16px; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1050; font-weight: 500; display: none; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; transform: translateY(-20px); }
        .message-box.show { display: block; opacity: 1; transform: translateY(0); }
        .message-box.success { background-color: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .message-box.error { background-color: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background-color: #ffffff; margin: auto; padding: 24px; border-radius: 0.75rem; width: 100%; max-width: 900px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 20px 40px -20px rgba(0,0,0,0.2); position: relative; animation: fadeInModal 0.3s ease-out; }
        @keyframes fadeInModal { from { opacity: 0; transform: scale(0.95) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .close-button { position: absolute; top: 16px; right: 16px; color: #9ca3af; font-size: 24px; line-height: 1; font-weight: bold; cursor: pointer; background: none; border: none; padding: 0; }
        .close-button:hover { color: #1f2937; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
        .form-grid-col-span-2 { grid-column: span 2 / span 2; }
        @media (max-width: 768px) { .form-grid-col-span-2 { grid-column: span 1 / span 1; } }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .admin-only { }
        .superadmin-only { display: none; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; text-align: center; min-width: 100px; }
        .status-con-hang { background-color: #d1fae5; color: #065f46; }
        .status-da-ghep { background-color: #fef3c7; color: #92400e; }
        .status-da-ban { background-color: #fee2e2; color: #991b1b; }
        .filter-input { padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; margin-bottom: 0; }
        .filter-input:focus { border-color: #4f46e5; outline: none; box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.3); }
        .autocomplete-container { position: relative; }
        .autocomplete-suggestions { position: absolute; border: 1px solid #d1d5db; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; background-color: white; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 0 0 0.5rem 0.5rem; }
        .autocomplete-item { padding: 10px; cursor: pointer; }
        .autocomplete-item:hover { background-color: #eef2ff; }
    </style>
</head>
<body>
    <div id="messageBox" class="message-box"></div>

    <div id="loginPage" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-100 to-purple-100 p-4">
        <div class="card w-full max-w-md p-8">
            <h2 class="text-3xl font-bold text-center mb-2 text-indigo-600">ƒêƒÉng nh·∫≠p H·ªá Th·ªëng</h2>
            <p class="text-center text-gray-600 mb-8">Qu·∫£n l√Ω kho xe v√† ƒë∆°n h√†ng hi·ªáu qu·∫£.</p>
            <div>
                <label for="username">T√™n ƒëƒÉng nh·∫≠p:</label>
                <input type="text" id="username" placeholder="v√≠ d·ª•: admin">
            </div>
            <div>
                <label for="password">M·∫≠t kh·∫©u:</label>
                <input type="password" id="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
            </div>
            <div class="mt-4 mb-6 flex items-center">
                <input id="rememberMe" name="remember-me" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="rememberMe" class="ml-2 block text-sm text-gray-700">L∆∞u t√†i kho·∫£n</label>
            </div>
            <button id="loginButton" class="btn-primary w-full py-3 text-lg">
                <i class="fas fa-spinner fa-spin mr-2 hidden" id="loginSpinner"></i>
                ƒêƒÉng nh·∫≠p
            </button>
        </div>
    </div>

    <div id="appPage" class="container hidden">
        <header class="flex justify-between items-center py-4 mb-6 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-indigo-700">H·ªá Th·ªëng Qu·∫£n L√Ω Kho Xe</h1>
            <div>
                <span id="currentUserDisplay" class="text-gray-700 mr-4"></span>
                <button id="logoutButton" class="btn-outline">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </header>

        <nav class="mb-8">
            <button id="tabVehicles" class="tab-button active">
                <i class="fas fa-car mr-2"></i>
                Qu·∫£n L√Ω Xe
            </button>
            <button id="tabOrders" class="tab-button">
                <i class="fas fa-file-invoice-dollar mr-2"></i>
                Qu·∫£n L√Ω ƒê∆°n H√†ng
            </button>
            <button id="tabDocuments" class="tab-button">
                <i class="fas fa-file-alt mr-2"></i>
                üìÑ In VƒÉn B·∫£n
            </button>
            <button id="tabAdmin" class="tab-button">
                <i class="fas fa-user-shield mr-2"></i>
                Admin Dashboard
            </button>
        </nav>

        <main>
            <div id="loadingSpinner" class="spinner hidden"></div>

            <div id="vehiclesTabContent" class="tab-content">
                 <p class="text-gray-600 mb-6 text-lg">Khu v·ª±c n√†y cho ph√©p b·∫°n xem, th√™m m·ªõi, c·∫≠p nh·∫≠t v√† x√≥a th√¥ng tin c√°c xe trong kho. Admin c√≥ to√†n quy·ªÅn qu·∫£n l√Ω, ng∆∞·ªùi xem ch·ªâ c√≥ th·ªÉ xem danh s√°ch.</p>
                <div id="vehicleFormCard" class="card">
                    <h2 class="text-2xl font-semibold text-indigo-600 mb-6">Th√™m / C·∫≠p nh·∫≠t Xe</h2>
                    <form id="vehicleForm">
                        <div class="form-grid">
                            <div><label for="chassisNumber">S·ªë Khung:</label><input type="text" id="chassisNumber" placeholder="S·ªë khung (VIN)" required></div>
                            <div><label for="vehicleName">T√™n Xe:</label><input type="text" id="vehicleName" placeholder="VD: VF9 Plus 7_nt N√¢u" required></div>
                            <div><label for="vehicleColor">M√†u S·∫Øc:</label><input type="text" id="vehicleColor" placeholder="VD: Tr·∫Øng"></div>
                            <div><label for="manufacturingYear">NƒÉm S·∫£n Xu·∫•t:</label><input type="number" id="manufacturingYear" placeholder="VD: 2025"></div>
                            <div><label for="engineNumber">COC:</label><input type="text" id="engineNumber" placeholder="V·ªã tr√≠ COC"></div>
                            <div><label for="importPrice">Gi√° Nh·∫≠p (VNƒê):</label><input type="number" id="importPrice" placeholder="Gi√° nh·∫≠p kho" step="1000"></div>
                            <div>
                                <label for="vehicleStatus">Tr·∫°ng Th√°i Xe:</label>
                                <select id="vehicleStatus">
                                    <option value="C√≤n h√†ng">C√≤n h√†ng</option>
                                    <option value="ƒê√£ Gh√©p">ƒê√£ Gh√©p</option>
                                    <option value="ƒê√£ b√°n">ƒê√£ b√°n</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-4 mt-6 admin-only">
                            <button type="submit" class="btn-primary flex-1 py-2.5">
                                <i class="fas fa-save mr-2"></i>
                                L∆∞u Xe
                            </button>
                            <button type="button" id="clearVehicleForm" class="btn-outline flex-1 py-2.5">
                                <i class="fas fa-times mr-2"></i>
                                X√≥a Form
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card mt-8">
                    <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Danh s√°ch Xe Trong Kho</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-8 gap-4 mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <div><label for="filterChassisNumber" class="text-xs font-medium">L·ªçc S·ªë Khung:</label><input type="text" id="filterChassisNumber" class="filter-input" placeholder="Nh·∫≠p s·ªë khung..."></div>
                        <div><label for="filterVehicleName" class="text-xs font-medium">L·ªçc T√™n Xe:</label><input type="text" id="filterVehicleName" class="filter-input" placeholder="Nh·∫≠p t√™n xe..."></div>
                        <div><label for="filterVehicleColor" class="text-xs font-medium">L·ªçc M√†u S·∫Øc:</label><input type="text" id="filterVehicleColor" class="filter-input" placeholder="Nh·∫≠p m√†u..."></div>
                        <div><label for="filterManYear" class="text-xs font-medium">L·ªçc NƒÉm SX:</label><input type="text" id="filterManYear" class="filter-input" placeholder="Nh·∫≠p nƒÉm..."></div>
                        <div><label for="filterCoc" class="text-xs font-medium">L·ªçc COC:</label><input type="text" id="filterCoc" class="filter-input" placeholder="Nh·∫≠p COC..."></div>
                        <div>
                            <label for="filterVehicleStatus" class="text-xs font-medium">L·ªçc Tr·∫°ng Th√°i:</label>
                            <select id="filterVehicleStatus" class="filter-input w-full">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="C√≤n h√†ng">C√≤n h√†ng</option>
                                <option value="ƒê√£ Gh√©p">ƒê√£ Gh√©p</option>
                                <option value="ƒê√£ b√°n">ƒê√£ b√°n</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterActualInventory" class="text-xs font-medium">T·ªìn Th·ª±c T·∫ø:</label>
                            <select id="filterActualInventory" class="filter-input w-full">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="c√≥">C√≥</option>
                                <option value="kh√¥ng">Kh√¥ng</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium block opacity-0">.</label>
                            <button id="clearVehicleFilters" class="btn-outline text-xs py-2 w-full">
                                <i class="fas fa-times mr-1"></i> X√≥a L·ªçc
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="vehiclesTable">
                            <thead>
                                <tr>
                                    <th>S·ªë Khung</th><th>T√™n Xe</th><th>M√†u S·∫Øc</th><th>NƒÉm SX</th>
                                    <th>COC</th><th>Gi√° Nh·∫≠p</th><th>Tr·∫°ng Th√°i Xe</th>
                                    <th>T·ªìn Th·ª±c T·∫ø?</th>
                                    <th class="admin-only">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                     <div id="noVehiclesMessage" class="text-center py-8 text-gray-500 hidden">Kh√¥ng c√≥ xe n√†o trong kho.</div>
                </div>
            </div>

            <div id="ordersTabContent" class="tab-content hidden">
                 <p class="text-gray-600 mb-6 text-lg">Khu v·ª±c n√†y cho ph√©p b·∫°n qu·∫£n l√Ω c√°c ƒë∆°n h√†ng, bao g·ªìm vi·ªác t·∫°o m·ªõi, c·∫≠p nh·∫≠t th√¥ng tin, v√† quan tr·ªçng nh·∫•t l√† gh√©p m·ªôt chi·∫øc xe c·ª• th·ªÉ t·ª´ kho v√†o ƒë∆°n h√†ng. Admin c√≥ to√†n quy·ªÅn qu·∫£n l√Ω.</p>
                 <div id="orderFormCard" class="card">
                    <h2 class="text-2xl font-semibold text-indigo-600 mb-6">Th√™m / C·∫≠p nh·∫≠t ƒê∆°n H√†ng</h2>
                    <form id="orderForm">
                        <div class="form-grid">
                            <div class="autocomplete-container">
                                <label for="orderChassisNumberInput">S·ªë Khung Xe:</label>
                                <input type="text" id="orderChassisNumberInput" placeholder="Nh·∫≠p ƒë·ªÉ t√¨m S·ªë Khung..." required autocomplete="off">
                                <div id="chassisAutocompleteSuggestions" class="autocomplete-suggestions hidden"></div>
                            </div>

                            <div><label for="orderCode">M√£ ƒê∆°n H√†ng:</label><input type="text" id="orderCode" placeholder="VD: S10601-VSO-25-26-0222" required></div>
                            <div><label for="vsoCode">M√£ B√°o G√≠a:</label><input type="text" id="vsoCode" placeholder="M√£ b√°o gi√° (n·∫øu c√≥)"></div>
                            <div><label for="customerName">T√™n Kh√°ch H√†ng:</label><input type="text" id="customerName" placeholder="Nguy·ªÖn VƒÉn A" required></div>
                            <div><label for="customerPhone">SƒêT Kh√°ch H√†ng:</label><input type="text" id="customerPhone" placeholder="09xxxxxxxx"></div>
                            <div><label for="customerIDNumber">CCCD/CMND/MST KH:</label><input type="text" id="customerIDNumber" placeholder="S·ªë ƒë·ªãnh danh"></div>
                            <div class="form-grid-col-span-2"><label for="customerAddress">ƒê·ªãa ch·ªâ Kh√°ch H√†ng:</label><input type="text" id="customerAddress" placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt"></div>

                            <div><label for="salesConsultant">T∆∞ V·∫•n BH:</label><input type="text" id="salesConsultant" placeholder="Tr·∫ßn Th·ªã B"></div>
                            <div><label for="showroomName">T√™n Showroom:</label><input type="text" id="showroomName" placeholder="Showroom Ch√≠nh"></div>

                            <div><label for="sellingPrice">Gi√° Ni√™m Y·∫øt (VNƒê):</label><input type="number" id="sellingPrice" placeholder="Gi√° ni√™m y·∫øt" step="1000"></div>
                            <div><label for="depositAmount">Ti·ªÅn C·ªçc (VNƒê):</label><input type="number" id="depositAmount" placeholder="S·ªë ti·ªÅn ƒë√£ c·ªçc" step="1000"></div>
                            <div><label for="discountAmount">Gi·∫£m Gi√° (VNƒê):</label><input type="number" id="discountAmount" placeholder="S·ªë ti·ªÅn gi·∫£m gi√°" step="1000"></div>
                            <div><label for="finalPrice">Gi√° Cu·ªëi C√πng (VNƒê):</label><input type="number" id="finalPrice" placeholder="Gi√° sau gi·∫£m gi√°" step="1000"></div>

                            <div class="form-grid-col-span-2"><label for="accessoriesPackage">G√≥i Ph·ª• Ki·ªán:</label><textarea id="accessoriesPackage" placeholder="Li·ªát k√™ ph·ª• ki·ªán v√† gi√°, v√≠ d·ª•: Film c√°ch nhi·ªát: 5.000.000 VNƒê, L√≥t s√†n: 2.000.000 VNƒê" rows="3"></textarea></div>

                            <div>
                                <label for="paymentStatus">TT Thanh To√°n:</label>
                                <select id="paymentStatus" required>
                                    <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
                                    <option value="Ch∆∞a c·ªçc">Ch∆∞a c·ªçc</option>
                                    <option value="ƒê√£ c·ªçc">ƒê√£ c·ªçc</option>
                                    <option value="ƒêang ch·ªù gi·∫£i ng√¢n">ƒêang ch·ªù gi·∫£i ng√¢n</option>
                                    <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
                                </select>
                            </div>
                            <div><label for="invoiceDate">Ng√†y Xu·∫•t Hƒê:</label><input type="date" id="invoiceDate"></div>
                            <div><label for="expectedDisbursementDate">Ng√†y DKGN:</label><input type="date" id="expectedDisbursementDate"></div>
                            <div><label for="actualDeliveryDate">Ng√†y Giao Xe TT:</label><input type="date" id="actualDeliveryDate"></div>

                            <div class="form-grid-col-span-2"><label for="orderNotes">Ghi Ch√∫ ƒêH:</label><textarea id="orderNotes" placeholder="Th√¥ng tin th√™m v·ªÅ ƒë∆°n h√†ng" rows="3"></textarea></div>
                        </div>
                        <div class="flex space-x-4 mt-6 admin-only">
                            <button type="submit" class="btn-primary flex-1 py-2.5"> <i class="fas fa-save mr-2"></i> L∆∞u ƒê∆°n H√†ng </button>
                            <button type="button" id="clearOrderForm" class="btn-outline flex-1 py-2.5"> <i class="fas fa-times mr-2"></i> X√≥a Form </button>
                        </div>
                    </form>
                </div>
                 <div class="card mt-8">
                    <h2 class="text-2xl font-semibold text-indigo-600 mb-6">Danh s√°ch ƒê∆°n H√†ng ƒê√£ Gh√©p Xe</h2>
                    <div class="table-container">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>S·ªë Khung Xe</th>
                                    <th>T√™n Xe</th>
                                    <th>Tr·∫°ng Th√°i Xe</th>
                                    <th>M√£ ƒê∆°n H√†ng</th>
                                    <th>T√™n Kh√°ch H√†ng</th>
                                    <th>T∆∞ v·∫•n BH</th>
                                    <th>Ti·ªÅn C·ªçc</th>
                                    <th>Gi√° Cu·ªëi C√πng</th>
                                    <th>TT Thanh To√°n</th>
                                    <th>Ng√†y Xu·∫•t Hƒê</th>
                                    <th>Ng√†y DKGN</th>
                                    <th>Ng√†y Giao TT</th>
                                    <th class="admin-only">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="noOrdersMessage" class="text-center py-8 text-gray-500 hidden">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c gh√©p xe.</div>
                </div>
            </div>

            <div id="documentsTabContent" class="tab-content hidden">
                <p class="text-gray-600 mb-6 text-lg">Khu v·ª±c n√†y cho ph√©p b·∫°n t·∫°o c√°c vƒÉn b·∫£n (v√≠ d·ª•: h·ª£p ƒë·ªìng, ƒë·ªÅ ngh·ªã) d·ª±a tr√™n th√¥ng tin ƒë∆°n h√†ng ƒë√£ c√≥, s·ª≠ d·ª•ng c√°c m·∫´u vƒÉn b·∫£n ƒë∆∞·ª£c ƒë·ªãnh s·∫µn.</p>
                <div class="card">
                    <h2 class="text-2xl font-semibold text-indigo-600 mb-6">T·∫°o VƒÉn B·∫£n t·ª´ M·∫´u Theo ƒê∆°n H√†ng</h2>
                    <div class="form-grid">
                        <div>
                            <label for="selectOrderForDoc">Ch·ªçn ƒê∆°n H√†ng (theo M√£ ƒêH):</label>
                            <select id="selectOrderForDoc">
                                <option value="">-- Vui l√≤ng ch·ªçn ƒë∆°n h√†ng --</option>
                            </select>
                        </div>
                        <div>
                            <label for="selectDocTemplate">Ch·ªçn M·∫´u VƒÉn B·∫£n:</label>
                            <select id="selectDocTemplate">
                                <option value="">-- Vui l√≤ng ch·ªçn m·∫´u --</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 admin-only">
                        <button id="generateDocumentButton" class="btn-primary py-2.5">
                            <i class="fas fa-cogs mr-2"></i>
                            T·∫°o VƒÉn B·∫£n
                        </button>
                    </div>
                    <div id="generatedDocLinkContainer" class="mt-6">
                        </div>
                </div>
            </div>

            <div id="adminTabContent" class="tab-content hidden">
                <p class="text-gray-600 mb-6 text-lg">T·ªïng quan s·ªë li·ªáu v√† c√°c ch·ª©c nƒÉng qu·∫£n tr·ªã h·ªá th·ªëng.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold text-indigo-600 mb-3 flex items-center">
                            <i class="fas fa-warehouse mr-3 text-2xl text-indigo-500"></i>
                            T·ªïng Quan Kho Xe
                        </h3>
                        <p class="text-gray-700 mb-1">T·ªïng s·ªë xe: <span id="totalVehiclesStat" class="font-bold text-indigo-700 text-lg">ƒêang t·∫£i...</span></p>
                        <p class="text-gray-700 mb-1">Xe c√≤n h√†ng: <span id="vehiclesAvailableStat" class="font-bold text-green-600">ƒêang t·∫£i...</span></p>
                        <p class="text-gray-700 mb-1">Xe ƒë√£ gh√©p: <span id="vehiclesPendingStat" class="font-bold text-yellow-600">ƒêang t·∫£i...</span></p>
                        <p class="text-gray-700">Xe ƒë√£ b√°n: <span id="vehiclesSoldStat" class="font-bold text-red-600">ƒêang t·∫£i...</span></p>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold text-indigo-600 mb-3 flex items-center">
                            <i class="fas fa-file-invoice-dollar mr-3 text-2xl text-indigo-500"></i>
                            T·ªïng Quan ƒê∆°n H√†ng
                        </h3>
                        <p class="text-gray-700 mb-1">T·ªïng s·ªë ƒë∆°n h√†ng ƒë√£ t·∫°o: <span id="totalOrdersStat" class="font-bold text-indigo-700 text-lg">ƒêang t·∫£i...</span></p>
                        <p class="text-gray-700 mb-1">ƒêH ch∆∞a c·ªçc: <span id="ordersNotDepositedStat" class="font-bold">ƒêang t·∫£i...</span></p>
                        <p class="text-gray-700 mb-1">ƒêH ƒë√£ c·ªçc: <span id="ordersDepositedStat" class="font-bold">ƒêang t·∫£i...</span></p>
                        <p class="text-gray-700 mb-1">ƒêH ch·ªù gi·∫£i ng√¢n: <span id="ordersPendingDisbursementStat" class="font-bold">ƒêang t·∫£i...</span></p>
                        <p class="text-gray-700">ƒêH ƒë√£ thanh to√°n: <span id="ordersPaidStat" class="font-bold text-green-600">ƒêang t·∫£i...</span></p>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold text-indigo-600 mb-3 flex items-center">
                            <i class="fas fa-hand-holding-usd mr-3 text-2xl text-indigo-500"></i>
                            Doanh Thu (∆Ø·ªõc T√≠nh)
                        </h3>
                        <p class="text-gray-700">T·ªïng doanh thu (xe ƒë√£ b√°n/thanh to√°n): <span id="totalRevenueStat" class="font-bold text-indigo-700 text-2xl">ƒêang t·∫£i...</span></p>
                        <small class="text-gray-500 italic block mt-2">(D·ª±a tr√™n "Gi√° cu·ªëi c√πng" c·ªßa c√°c xe c√≥ "M√£ ƒê∆°n H√†ng" v√† ("Tr·∫°ng Th√°i Xe" l√† "ƒê√£ b√°n" ho·∫∑c "TT Thanh To√°n" l√† "ƒê√£ thanh to√°n"))</small>
                    </div>
                </div>

                <div id="userManagementSection" class="card mt-6 superadmin-only">
                    <h3 class="text-2xl font-semibold text-purple-600 mb-6 flex items-center">
                        <i class="fas fa-users-cog mr-3 text-2xl text-purple-500"></i>
                        Qu·∫£n L√Ω Ng∆∞·ªùi D√πng (Superadmin)
                    </h3>
                    <div class="mb-8 p-6 border border-purple-200 rounded-lg bg-purple-50">
                        <h4 class="text-xl font-semibold text-purple-700 mb-4">Th√™m Ng∆∞·ªùi D√πng M·ªõi</h4>
                        <form id="addUserForm" class="form-grid">
                            <div>
                                <label for="newUsername">T√™n ƒëƒÉng nh·∫≠p m·ªõi:</label>
                                <input type="text" id="newUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                            </div>
                            <div>
                                <label for="newPassword">M·∫≠t kh·∫©u m·ªõi:</label>
                                <input type="password" id="newPassword" placeholder="√çt nh·∫•t 6 k√Ω t·ª±" required>
                            </div>
                            <div>
                                <label for="newUserRole">Vai tr√≤:</label>
                                <select id="newUserRole">
                                    <option value="viewer">Viewer</option>
                                    <option value="admin">Admin</option>
                                    <option value="superadmin">Superadmin</option>
                                </select>
                            </div>
                            <div class="mt-2">
                                <button type="submit" class="btn-primary bg-purple-600 hover:bg-purple-700 border-purple-600 py-2.5">
                                    <i class="fas fa-user-plus mr-2"></i>Th√™m Ng∆∞·ªùi D√πng
                                </button>
                            </div>
                        </form>
                    </div>

                    <div>
                        <h4 class="text-xl font-semibold text-purple-700 mb-4">Danh S√°ch Ng∆∞·ªùi D√πng</h4>
                        <div class="table-container">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>T√™n ƒêƒÉng Nh·∫≠p</th>
                                        <th>Vai Tr√≤</th>
                                        <th>H√†nh ƒê·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    </tbody>
                            </table>
                        </div>
                        <div id="noUsersMessageForAdminList" class="text-center py-6 text-gray-500 hidden">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ƒë·ªÉ hi·ªÉn th·ªã.</div>
                    </div>
                </div>
                </div>
            </main>
    </div>

    <div id="confirmationModal" class="modal">
        <!-- N·ªôi dung modal x√°c nh·∫≠n gi·ªØ nguy√™n -->
    </div>

    <script>
        // --- Global Variables & Element Selectors ---
        let allAvailableVehicles = []; 
        let currentUserRole = null;
        let currentEditingChassisNumberVehicle = null;
        let currentEditingChassisNumberOrder = null;
        const el = (id) => document.getElementById(id);
        const q = (selector) => document.querySelector(selector);
        const qAll = (selector) => document.querySelectorAll(selector);
        const loginPage = el('loginPage');
        const appPage = el('appPage');
        const loginButton = el('loginButton');
        const logoutButton = el('logoutButton');
        const usernameInput = el('username');
        const passwordInput = el('password');
        const currentUserDisplay = el('currentUserDisplay');
        const loginSpinner = el('loginSpinner');
        const loadingSpinner = el('loadingSpinner');
        const tabs = { vehicles: { button: el('tabVehicles'), content: el('vehiclesTabContent') }, orders: { button: el('tabOrders'), content: el('ordersTabContent') }, documents: { button: el('tabDocuments'), content: el('documentsTabContent') }, admin: { button: el('tabAdmin'), content: el('adminTabContent') } };
        const vehicleForm = el('vehicleForm');
        const vehiclesTableBody = q('#vehiclesTable tbody');
        const clearVehicleFormButton = el('clearVehicleForm');
        const noVehiclesMessage = el('noVehiclesMessage');
        const orderForm = el('orderForm');
        const ordersTableBody = q('#ordersTable tbody');
        const clearOrderFormButton = el('clearOrderForm');
        const noOrdersMessage = el('noOrdersMessage');
        const selectOrderForDoc = el('selectOrderForDoc');
        const selectDocTemplate = el('selectDocTemplate');
        const generateDocumentButton = el('generateDocumentButton');
        const generatedDocLinkContainer = el('generatedDocLinkContainer');
        const totalVehiclesStat = el('totalVehiclesStat');
        const vehiclesAvailableStat = el('vehiclesAvailableStat');
        const vehiclesPendingStat = el('vehiclesPendingStat');
        const vehiclesSoldStat = el('vehiclesSoldStat');
        const totalOrdersStat = el('totalOrdersStat');
        const ordersNotDepositedStat = el('ordersNotDepositedStat');
        const ordersDepositedStat = el('ordersDepositedStat');
        const ordersPendingDisbursementStat = el('ordersPendingDisbursementStat');
        const ordersPaidStat = el('ordersPaidStat');
        const totalRevenueStat = el('totalRevenueStat');
        const userManagementSection = el('userManagementSection');
        const addUserForm = el('addUserForm');
        const newUsernameInput = el('newUsername');
        const newPasswordInput = el('newPassword');
        const newUserRoleSelect = el('newUserRole');
        const usersTableBody = el('usersTableBody');
        const noUsersMessageForAdminList = el('noUsersMessageForAdminList');
        const confirmationModal = el('confirmationModal');
        const confirmationMessage = el('confirmationMessage');
        const confirmActionBtn = el('confirmAction');
        const cancelConfirmBtn = el('cancelConfirm');
        const closeConfirmModalBtn = el('closeConfirmModal');
        const vehicleFormCard = el('vehicleFormCard');
        const orderFormCard = el('orderFormCard');
        const rememberMeCheckbox = el('rememberMe');
        const filterChassisNumberInput = el('filterChassisNumber');
        const filterVehicleNameInput = el('filterVehicleName');
        const filterVehicleColorInput = el('filterVehicleColor');
        const filterManYearInput = el('filterManYear');
        const filterCocInput = el('filterCoc');
        const filterVehicleStatusSelect = el('filterVehicleStatus');
        const filterActualInventorySelect = el('filterActualInventory');
        const clearVehicleFiltersButton = el('clearVehicleFilters');
        const orderChassisNumberInput = el('orderChassisNumberInput');
        const chassisAutocompleteSuggestions = el('chassisAutocompleteSuggestions');

        // --- UI Helper Functions ---
        function showSpinner(show = true) { loadingSpinner.style.display = show ? 'block' : 'none'; }
        function showLoginSpinner(show = true) { loginSpinner.classList.toggle('hidden', !show); loginButton.disabled = show; }
        function showMessage(message, type = 'success', duration = 3000) { const mb = el('messageBox'); mb.textContent = message; mb.className = `message-box ${type}`; mb.classList.add('show'); setTimeout(() => mb.classList.remove('show'), duration); }
        function showConfirmationModalDialog(message, onConfirm) { confirmationMessage.textContent = message; confirmationModal.style.display = 'flex'; confirmActionBtn.onclick = () => { confirmationModal.style.display = 'none'; onConfirm(true); }; cancelConfirmBtn.onclick = () => { confirmationModal.style.display = 'none'; onConfirm(false); }; closeConfirmModalBtn.onclick = () => { confirmationModal.style.display = 'none'; onConfirm(false); };}

        // --- Tab Switching and UI Update ---
        function switchTab(tabName) { Object.values(tabs).forEach(t => { if (t.button) t.button.classList.remove('active'); if (t.content) t.content.classList.add('hidden');}); if (tabs[tabName] && tabs[tabName].button && tabs[tabName].content) { tabs[tabName].button.classList.add('active'); tabs[tabName].content.classList.remove('hidden');} if (tabName === 'vehicles') loadVehicles(); else if (tabName === 'orders') { loadOrders(); loadAvailableVehiclesForOrderForm(); } else if (tabName === 'documents') { loadOrdersForDocumentTab(); loadDocumentTemplates(); } else if (tabName === 'admin') { loadAdminDashboardData(); if (currentUserRole === 'superadmin') loadUsers(); }}
        
        function updateUIForRole() {
            const isAdmin = currentUserRole === 'admin' || currentUserRole === 'superadmin';
            const isSuperAdmin = currentUserRole === 'superadmin';
            const isViewer = currentUserRole === 'viewer';
            console.log("updateUIForRole called. currentUserRole:", currentUserRole, "isAdmin:", isAdmin, "isSuperAdmin:", isSuperAdmin, "isViewer:", isViewer);

            qAll('.admin-only').forEach(elem => {
                 if (elem.id !== 'tabAdmin' && elem.id !== 'tabDocuments' && !elem.closest('#userManagementSection')) { 
                     elem.style.display = isAdmin ? '' : 'none';
                 }
            });
            const formElementsToToggle = [
                ...qAll('#vehicleForm input, #vehicleForm select, #vehicleForm textarea, #vehicleForm button[type="submit"]'),
                ...qAll('#orderForm input, #orderForm select, #orderForm textarea, #orderForm button[type="submit"]'),
                el('selectOrderForDoc'), el('selectDocTemplate'), el('generateDocumentButton')
            ];
            formElementsToToggle.forEach(e => { if(e) e.disabled = !isAdmin; });

            if (tabs.admin.button) {
                tabs.admin.button.style.display = isAdmin ? 'inline-flex' : 'none';
            }
            if (tabs.documents.button) {
                 tabs.documents.button.style.display = isAdmin ? 'inline-flex' : 'none';
            }
            qAll('.superadmin-only').forEach(e => {
                e.style.display = isSuperAdmin ? 'block' : 'none';
            });
            if (addUserForm) qAll('#addUserForm input, #addUserForm select, #addUserForm button[type="submit"]').forEach(e => e.disabled = !isSuperAdmin);
            if (vehicleFormCard) {
                vehicleFormCard.style.display = isViewer ? 'none' : (isAdmin ? 'block' : 'none');
            }
            if (orderFormCard) {
                orderFormCard.style.display = isViewer ? 'none' : (isAdmin ? 'block' : 'none');
            }
            if (!isAdmin) {
                if (currentEditingChassisNumberVehicle) clearVehicleForm();
                if (currentEditingChassisNumberOrder) clearOrderForm();
            }
        }

        // --- Google Script Run ---
        async function googleScriptRun(functionName, ...args) { showSpinner(); return new Promise((resolve, reject) => { if(typeof google === 'undefined' || !google.script) { reject(new Error("M√¥i tr∆∞·ªùng Google Script ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i.")); showSpinner(false); return; } google.script.run .withSuccessHandler(response => { showSpinner(false); if (response && response.success === false && response.message) { console.error("Apps Script Error for " + functionName + ":", response.message); reject(new Error(response.message)); } else { resolve(response); } }) .withFailureHandler(error => { showSpinner(false); console.error('Google Script Failure Handler:', functionName, error); reject(error); }) [functionName](...args); });}

        // --- CRUD and other functions (gi·ªØ nguy√™n) ---
        async function loadVehicles() { try { const d = await googleScriptRun('getVehiclesWithOrders'); displayVehicles(d||[]); filterVehiclesTable(); } catch(e){ showMessage(`L·ªói t·∫£i xe: ${e.message||e}`,'error'); displayVehicles([]); } }
        function displayVehicles(vs) { vehiclesTableBody.innerHTML=''; if(!vs||vs.length===0){noVehiclesMessage.textContent = "Kh√¥ng c√≥ xe n√†o trong kho."; noVehiclesMessage.classList.remove('hidden');return;} noVehiclesMessage.classList.add('hidden'); vs.forEach(v=>{ const r=vehiclesTableBody.insertRow(); r.insertCell().textContent=v["S·ªë Khung"]; r.insertCell().textContent=v["T√™n Xe"]; r.insertCell().textContent=v["M√†u S·∫Øc"]; r.insertCell().textContent=v["NƒÉm S·∫£n Xu·∫•t"]; r.insertCell().textContent=v["S·ªë M√°y"]; const ip=parseFloat(v["Gi√° Nh·∫≠p"]); r.insertCell().textContent=isNaN(ip)?'':ip.toLocaleString('vi-VN',{style:'currency',currency:'VND'}); const sc=r.insertCell(); const ss=document.createElement('span'); ss.classList.add('status-badge'); ss.textContent=v["Tr·∫°ng Th√°i Xe"]||'N/A'; if(v["Tr·∫°ng Th√°i Xe"]==="C√≤n h√†ng")ss.classList.add('status-con-hang'); else if(v["Tr·∫°ng Th√°i Xe"]==="ƒê√£ Gh√©p")ss.classList.add('status-da-ghep'); else if(v["Tr·∫°ng Th√°i Xe"]==="ƒê√£ b√°n")ss.classList.add('status-da-ban'); else ss.classList.add('bg-gray-100','text-gray-800'); sc.appendChild(ss); const actualInvCell = r.insertCell(); const actualInvSpan = document.createElement('span'); actualInvSpan.classList.add('status-badge'); if(v.isActualInventory){ actualInvSpan.textContent = "C√≥"; actualInvSpan.classList.add('status-con-hang');} else { actualInvSpan.textContent = "Kh√¥ng"; actualInvSpan.classList.add('status-da-ban');} actualInvCell.appendChild(actualInvSpan); const ac=r.insertCell(); ac.classList.add('admin-only','space-x-2'); if(currentUserRole==='admin'||currentUserRole==='superadmin'){ const eb=document.createElement('button'); eb.innerHTML=`<i class="fas fa-edit"></i>`; eb.classList.add('btn-outline','px-2','py-1','text-sm'); eb.title="S·ª≠a xe"; eb.onclick=()=>editVehicle(v); ac.appendChild(eb); const db=document.createElement('button'); db.innerHTML=`<i class="fas fa-trash-alt"></i>`; db.classList.add('btn-danger','px-2','py-1','text-sm'); db.title="X√≥a xe"; db.onclick=()=>showConfirmationModalDialog(`X√≥a xe "${v["T√™n Xe"]}"?`, c=>{if(c)deleteVehicleAction(v["S·ªë Khung"])}); ac.appendChild(db);}}); updateUIForRole(); }
        function editVehicle(v) { currentEditingChassisNumberVehicle=v["S·ªë Khung"]; el('chassisNumber').value=v["S·ªë Khung"]; el('chassisNumber').readOnly=true; el('vehicleName').value=v["T√™n Xe"]; el('vehicleColor').value=v["M√†u S·∫Øc"]; el('manufacturingYear').value=v["NƒÉm S·∫£n Xu·∫•t"]; el('engineNumber').value=v["S·ªë M√°y"]; el('importPrice').value=v["Gi√° Nh·∫≠p"]; el('vehicleStatus').value=v["Tr·∫°ng Th√°i Xe"]; vehicleForm.scrollIntoView({behavior:'smooth'});}
        async function deleteVehicleAction(cn) { try { const res=await googleScriptRun('deleteVehicle',cn); if(res.success){showMessage(res.message); loadVehicles();loadOrders();loadAvailableVehiclesForOrderForm();loadOrdersForDocumentTab();} else{showMessage(res.message,'error');}} catch(e){showMessage(`L·ªói x√≥a xe: ${e.message||e}`,'error');}}
        vehicleForm.addEventListener('submit', async e => { e.preventDefault(); const cn=el('chassisNumber').value.trim(); if(!cn){showMessage("S·ªë Khung l√† b·∫Øt bu·ªôc.","error");return;} const vd={"S·ªë Khung":cn, "T√™n Xe":el('vehicleName').value.trim(), "M√†u S·∫Øc":el('vehicleColor').value.trim(), "NƒÉm S·∫£n Xu·∫•t":parseInt(el('manufacturingYear').value)||null, "S·ªë M√°y":el('engineNumber').value.trim(), "Gi√° Nh·∫≠p":parseFloat(el('importPrice').value)||null, "Tr·∫°ng Th√°i Xe":el('vehicleStatus').value}; try { let res; if(currentEditingChassisNumberVehicle){res=await googleScriptRun('updateVehicle',vd);}else{res=await googleScriptRun('addVehicle',vd);} if(res.success){showMessage(res.message);clearVehicleForm();loadVehicles();loadAvailableVehiclesForOrderForm();loadOrdersForDocumentTab();}else{showMessage(res.message,'error');}} catch(e){showMessage(`L·ªói l∆∞u xe: ${e.message||e}`,'error');}});
        function clearVehicleForm() { vehicleForm.reset(); el('chassisNumber').readOnly=false; currentEditingChassisNumberVehicle=null; el('vehicleStatus').value="C√≤n h√†ng";}
        clearVehicleFormButton.addEventListener('click', clearVehicleForm);
        async function loadOrders() { try { const d=await googleScriptRun('getVehiclesWithOrders'); const o=d.filter(i=>i&&i["M√£ ƒê∆°n H√†ng"]); displayOrders(o||[]);} catch(e){showMessage(`L·ªói t·∫£i ƒë∆°n h√†ng: ${e.message||e}`,'error');displayOrders([]);}}
        function displayOrders(orders) { ordersTableBody.innerHTML = ''; if (!orders || orders.length === 0) { noOrdersMessage.classList.remove('hidden'); return; } noOrdersMessage.classList.add('hidden'); orders.forEach(order => { const row = ordersTableBody.insertRow(); row.insertCell().textContent = order["S·ªë Khung"] || ''; row.insertCell().textContent = order["T√™n Xe"] || ''; row.insertCell().textContent = order["Tr·∫°ng Th√°i Xe"] || ''; row.insertCell().textContent = order["M√£ ƒê∆°n H√†ng"] || ''; row.insertCell().textContent = order["T√™n Kh√°ch H√†ng"] || ''; row.insertCell().textContent = order["T∆∞ V·∫•n BH"] || ''; const depositAmt = parseFloat(order["Ti·ªÅn c·ªçc"]); row.insertCell().textContent = isNaN(depositAmt) ? '' : depositAmt.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); const finalSalePrice = parseFloat(order["Gi√° cu·ªëi c√πng"]); row.insertCell().textContent = isNaN(finalSalePrice) ? '' : finalSalePrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); row.insertCell().textContent = order["TT Thanh To√°n"] || ''; row.insertCell().textContent = order["Ng√†y Xu·∫•t Hƒê"] ? new Date(order["Ng√†y Xu·∫•t Hƒê"]).toLocaleDateString('vi-VN') : ''; row.insertCell().textContent = order["Ng√†y DKGN"] ? new Date(order["Ng√†y DKGN"]).toLocaleDateString('vi-VN') : ''; row.insertCell().textContent = order["Ng√†y Giao Xe TT"] ? new Date(order["Ng√†y Giao Xe TT"]).toLocaleDateString('vi-VN') : ''; const actionsCell = row.insertCell(); actionsCell.classList.add('admin-only', 'space-x-2'); if (currentUserRole === 'admin' || currentUserRole === 'superadmin') { const editBtn = document.createElement('button'); editBtn.innerHTML = `<i class="fas fa-edit"></i>`; editBtn.classList.add('btn-outline', 'px-2', 'py-1', 'text-sm'); editBtn.title = "S·ª≠a ƒë∆°n"; editBtn.onclick = () => editOrder(order); actionsCell.appendChild(editBtn); const clearOrderBtn = document.createElement('button'); clearOrderBtn.innerHTML = `<i class="fas fa-undo"></i>`; clearOrderBtn.classList.add('btn-secondary', 'px-2', 'py-1', 'text-sm'); clearOrderBtn.title = "X√≥a ƒë∆°n"; clearOrderBtn.onclick = () => showConfirmationModalDialog(`X√≥a ƒë∆°n cho xe "${order["T√™n Xe"]}"?`, c => { if (c) clearOrderForVehicleAction(order["S·ªë Khung"]) }); actionsCell.appendChild(clearOrderBtn); } }); updateUIForRole(); }
        async function loadAvailableVehiclesForOrderForm() { try { const d=await googleScriptRun('getVehiclesWithOrders'); allAvailableVehicles = d.filter(v=>(v["Tr·∫°ng Th√°i Xe"]==="C√≤n h√†ng"||v["Tr·∫°ng Th√°i Xe"]==="ƒê√£ Gh√©p")||(currentEditingChassisNumberOrder&&v["S·ªë Khung"]===currentEditingChassisNumberOrder)); }catch(e){showMessage(`L·ªói t·∫£i xe cho ƒë∆°n: ${e.message||e}`,'error');}}
        function populateOrderFormFields(dataObject) { orderChassisNumberInput.value = dataObject["S·ªë Khung"] || ''; el('orderCode').value=dataObject["M√£ ƒê∆°n H√†ng"]||''; el('vsoCode').value=dataObject["M√£ VSO"]||''; el('customerName').value=dataObject["T√™n Kh√°ch H√†ng"]||''; el('customerPhone').value=dataObject["SƒêT KH"]||''; el('customerIDNumber').value=dataObject["CCCD/MST KH"]||''; el('customerAddress').value=dataObject["ƒê·ªãa ch·ªâ KH"]||''; el('salesConsultant').value=dataObject["T∆∞ V·∫•n BH"]||''; el('showroomName').value=dataObject["T√™n Showroom"]||''; el('sellingPrice').value=dataObject["Gi√° B√°n"]||''; el('depositAmount').value=dataObject["Ti·ªÅn c·ªçc"]||''; el('accessoriesPackage').value=dataObject["G√≥i ph·ª• ki·ªán"]||''; el('discountAmount').value=dataObject["Gi·∫£m gi√°"]||''; el('finalPrice').value=dataObject["Gi√° cu·ªëi c√πng"]||''; el('paymentStatus').value=dataObject["TT Thanh To√°n"]||''; el('invoiceDate').value=dataObject["Ng√†y Xu·∫•t Hƒê"]?new Date(dataObject["Ng√†y Xu·∫•t Hƒê"]).toISOString().split('T')[0]:''; el('expectedDisbursementDate').value=dataObject["Ng√†y DKGN"]?new Date(dataObject["Ng√†y DKGN"]).toISOString().split('T')[0]:''; el('actualDeliveryDate').value=dataObject["Ng√†y Giao Xe TT"]?new Date(dataObject["Ng√†y Giao Xe TT"]).toISOString().split('T')[0]:''; el('orderNotes').value=dataObject["Ghi Ch√∫ ƒêH"]||'';}
        function editOrder(o) { currentEditingChassisNumberOrder=o["S·ªë Khung"]; loadAvailableVehiclesForOrderForm().then(()=>{ populateOrderFormFields(o); el('orderCode').readOnly=!!o["M√£ ƒê∆°n H√†ng"]; orderForm.scrollIntoView({behavior:'smooth'});});}
        async function clearOrderForVehicleAction(cn) { try { const res=await googleScriptRun('clearOrderForVehicle',cn); if(res.success){showMessage(res.message);loadOrders();loadVehicles();loadAvailableVehiclesForOrderForm();}else{showMessage(res.message,'error');}}catch(e){showMessage(`L·ªói x√≥a ƒë∆°n: ${e.message||e}`,'error');}}
        orderForm.addEventListener('submit', async e => { e.preventDefault(); const cn=el('orderChassisNumberInput').value; const oc=el('orderCode').value.trim(); if(!cn){showMessage("Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p S·ªë Khung.","error");return;} if(el('paymentStatus').value === ""){showMessage("Vui l√≤ng ch·ªçn Tr·∫°ng Th√°i Thanh To√°n.","error");return;} const od={"S·ªë Khung":cn,"M√£ ƒê∆°n H√†ng":oc,"M√£ VSO":el('vsoCode').value.trim(),"T√™n Kh√°ch H√†ng":el('customerName').value.trim(),"SƒêT KH":el('customerPhone').value.trim(),"CCCD/MST KH":el('customerIDNumber').value.trim(),"ƒê·ªãa ch·ªâ KH":el('customerAddress').value.trim(),"T∆∞ V·∫•n BH":el('salesConsultant').value.trim(),"T√™n Showroom":el('showroomName').value.trim(),"Gi√° B√°n":parseFloat(el('sellingPrice').value)||null,"Ti·ªÅn c·ªçc":parseFloat(el('depositAmount').value)||null,"G√≥i ph·ª• ki·ªán":el('accessoriesPackage').value.trim(),"Gi·∫£m gi√°":parseFloat(el('discountAmount').value)||null,"Gi√° cu·ªëi c√πng":parseFloat(el('finalPrice').value)||null,"TT Thanh To√°n":el('paymentStatus').value,"Ng√†y Xu·∫•t Hƒê":el('invoiceDate').value||null,"Ng√†y DKGN":el('expectedDisbursementDate').value||null,"Ng√†y Giao Xe TT":el('actualDeliveryDate').value||null,"Ghi Ch√∫ ƒêH":el('orderNotes').value.trim()}; try { const res=await googleScriptRun('saveOrder',od); if(res.success){showMessage(res.message);clearOrderForm();loadOrders();loadVehicles();loadAvailableVehiclesForOrderForm();}else{showMessage(res.message,'error');}}catch(e){showMessage(`L·ªói l∆∞u ƒë∆°n: ${e.message||e}`,'error');}});
        function clearOrderForm() { orderForm.reset(); orderChassisNumberInput.value=""; currentEditingChassisNumberOrder=null; el('orderCode').readOnly=false;}
        clearOrderFormButton.addEventListener('click', clearOrderForm);
        async function loadOrdersForDocumentTab() { try { const d=await googleScriptRun('getVehiclesWithOrders'); selectOrderForDoc.innerHTML='<option value="">-- Vui l√≤ng ch·ªçn ƒë∆°n h√†ng --</option>'; const os=d.filter(i=>i&&i["M√£ ƒê∆°n H√†ng"]); if(os.length===0){const op=document.createElement('option');op.value="";op.textContent="Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o";op.disabled=true;selectOrderForDoc.appendChild(op);return;} os.forEach(o=>{const op=document.createElement('option');op.value=o["M√£ ƒê∆°n H√†ng"];op.textContent=`${o["M√£ ƒê∆°n H√†ng"]} - KH: ${o["T√™n Kh√°ch H√†ng"]||'N/A'} - Xe: ${o["T√™n Xe"]||o["S·ªë Khung"]}`; selectOrderForDoc.appendChild(op);});}catch(e){showMessage(`L·ªói t·∫£i danh s√°ch ƒë∆°n h√†ng cho tab vƒÉn b·∫£n: ${e.message||e}`,'error');selectOrderForDoc.innerHTML='<option value="">-- L·ªói t·∫£i ƒë∆°n h√†ng --</option>';}}
        async function loadDocumentTemplates() { try { const ts=await googleScriptRun('getDocTemplates'); selectDocTemplate.innerHTML='<option value="">-- Ch·ªçn m·∫´u --</option>'; if(ts&&ts.length>0){ts.forEach(t=>{const o=document.createElement('option');o.value=t.id;o.textContent=t.name; selectDocTemplate.appendChild(o);});}else{selectDocTemplate.innerHTML='<option value="">-- Kh√¥ng c√≥ m·∫´u --</option>';}}catch(e){showMessage(`L·ªói t·∫£i m·∫´u VB: ${e.message||e}`,'error');selectDocTemplate.innerHTML='<option value="">-- L·ªói t·∫£i m·∫´u --</option>';}}
        generateDocumentButton.addEventListener('click', async () => { const soc=selectOrderForDoc.value; const st=selectDocTemplate.value; if(!soc){showMessage("Vui l√≤ng ch·ªçn m·ªôt ƒë∆°n h√†ng.","error");return;} if(!st){showMessage("Vui l√≤ng ch·ªçn m·ªôt m·∫´u vƒÉn b·∫£n.","error");return;} generatedDocLinkContainer.innerHTML='<div class="spinner" style="margin:10px 0;"></div> <p class="text-sm text-gray-600">ƒêang t·∫°o VB...</p>'; try { const res=await googleScriptRun('generateDocument',soc,st); if(res.success){showMessage(res.message||"T·∫°o VB th√†nh c√¥ng!"); generatedDocLinkContainer.innerHTML=`<p class="text-green-600 font-semibold">VB ƒë√£ t·∫°o!</p><a href="${res.docUrl}" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline"><i class="fas fa-external-link-alt mr-1"></i> M·ªü VB</a><p class="text-xs text-gray-500 mt-1">L∆∞u √Ω: VB t·∫°o trong Google Drive.</p>`;}else{showMessage(res.message||"L·ªói t·∫°o VB.","error");generatedDocLinkContainer.innerHTML=`<p class="text-red-600">L·ªói: ${res.message||"Kh√¥ng th·ªÉ t·∫°o VB."}</p>`;}}catch(e){showMessage(`L·ªói nghi√™m tr·ªçng khi t·∫°o VB: ${e.message||e}`,'error');generatedDocLinkContainer.innerHTML=`<p class="text-red-600">L·ªói: ${e.message||"Kh√¥ng th·ªÉ t·∫°o VB."}</p>`;}});
        async function loadAdminDashboardData() { const ses={totalVehiclesStat:el('totalVehiclesStat'),vehiclesAvailableStat:el('vehiclesAvailableStat'),vehiclesPendingStat:el('vehiclesPendingStat'),vehiclesSoldStat:el('vehiclesSoldStat'),totalOrdersStat:el('totalOrdersStat'),ordersNotDepositedStat:el('ordersNotDepositedStat'),ordersDepositedStat:el('ordersDepositedStat'),ordersPendingDisbursementStat:el('ordersPendingDisbursementStat'),ordersPaidStat:el('ordersPaidStat'),totalRevenueStat:el('totalRevenueStat')}; Object.values(ses).forEach(e=>{if(e)e.textContent='ƒêang t·∫£i...';}); try { const res=await googleScriptRun('getAdminDashboardStats'); if(res&&res.success){ const s=res.data; if(ses.totalVehiclesStat)ses.totalVehiclesStat.textContent=s.totalVehicles||0; if(ses.vehiclesAvailableStat)ses.vehiclesAvailableStat.textContent=s.vehiclesByStatus?.["C√≤n h√†ng"]||0; if(ses.vehiclesPendingStat)ses.vehiclesPendingStat.textContent=s.vehiclesByStatus?.["ƒê√£ Gh√©p"]||0; if(ses.vehiclesSoldStat)ses.vehiclesSoldStat.textContent=s.vehiclesByStatus?.["ƒê√£ b√°n"]||0; if(ses.totalOrdersStat)ses.totalOrdersStat.textContent=s.totalOrders||0; if(ses.ordersNotDepositedStat)ses.ordersNotDepositedStat.textContent=s.ordersByPaymentStatus?.["Ch∆∞a c·ªçc"]||0; if(ses.ordersDepositedStat)ses.ordersDepositedStat.textContent=s.ordersByPaymentStatus?.["ƒê√£ c·ªçc"]||0; if(ses.ordersPendingDisbursementStat)ses.ordersPendingDisbursementStat.textContent=s.ordersByPaymentStatus?.["ƒêang ch·ªù gi·∫£i ng√¢n"]||0; if(ses.ordersPaidStat)ses.ordersPaidStat.textContent=s.ordersByPaymentStatus?.["ƒê√£ thanh to√°n"]||0; const rev=parseFloat(s.totalRevenue); if(ses.totalRevenueStat)ses.totalRevenueStat.textContent=isNaN(rev)?'0 VNƒê':rev.toLocaleString('vi-VN',{style:'currency',currency:'VND'});}else{throw new Error(res.message||"Kh√¥ng th·ªÉ t·∫£i dashboard.");}}catch(e){showMessage(`L·ªói t·∫£i Admin Dashboard: ${e.message||e}`,'error');Object.values(ses).forEach(el=>{if(el)el.textContent='L·ªói t·∫£i';});}}
        async function loadUsers() { if (currentUserRole !== 'superadmin') return; try { const res = await googleScriptRun('getUsers'); if (res.success) { displayUsers(res.users || []); } else { showMessage(res.message || "Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng.", 'error'); displayUsers([]); } } catch (err) { showMessage(`L·ªói t·∫£i danh s√°ch ng∆∞·ªùi d√πng: ${err.message || err.toString()}`, 'error'); displayUsers([]); }}
        function displayUsers(us) { usersTableBody.innerHTML = ''; const numEl = el('noUsersMessageForAdminList'); if (!us || us.length === 0) { if(numEl) numEl.classList.remove('hidden'); return; } if(numEl) numEl.classList.add('hidden'); us.forEach(u => { const r = usersTableBody.insertRow(); r.insertCell().textContent = u.username; r.insertCell().textContent = u.role; const ac = r.insertCell(); ac.classList.add('space-x-2'); if (u.username === 'superadmin') { ac.textContent = "Kh√¥ng th·ªÉ s·ª≠a/x√≥a"; } else { const cpb = document.createElement('button'); cpb.innerHTML = `<i class="fas fa-key mr-1"></i> ƒê·ªïi MK`; cpb.classList.add('btn-outline', 'btn-sm', 'text-xs', 'px-2', 'py-1'); cpb.onclick = () => promptForNewPassword(u.username); ac.appendChild(cpb); const crb = document.createElement('button'); crb.innerHTML = `<i class="fas fa-user-shield mr-1"></i> ƒê·ªïi Vai Tr√≤`; crb.classList.add('btn-outline', 'btn-sm', 'text-xs', 'px-2', 'py-1'); crb.onclick = () => promptForNewRole(u.username, u.role); ac.appendChild(crb); const dub = document.createElement('button'); dub.innerHTML = `<i class="fas fa-user-times"></i>`; dub.classList.add('btn-danger', 'btn-sm', 'text-xs', 'px-2', 'py-1'); dub.title = "X√≥a ng∆∞·ªùi d√πng"; dub.onclick = () => showConfirmationModalDialog(`X√≥a ng∆∞·ªùi d√πng "${u.username}"?`, c => { if (c) deleteUserAction(u.username); }); ac.appendChild(dub); } });}
        addUserForm.addEventListener('submit', async (e) => { e.preventDefault(); const nu = newUsernameInput.value.trim(); const np = newPasswordInput.value; const nr = newUserRoleSelect.value; if (!nu || !np || !nr) { showMessage("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ng∆∞·ªùi d√πng m·ªõi.", "error"); return; } if (np.length < 6) { showMessage("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.", "error"); return; } try { const res = await googleScriptRun('addManagedUser', nu, np, nr); if (res.success) { showMessage(res.message); addUserForm.reset(); loadUsers(); } else { showMessage(res.message, 'error'); } } catch (err) { showMessage(`L·ªói th√™m ng∆∞·ªùi d√πng: ${err.message || err.toString()}`, 'error'); }});
        function promptForNewPassword(username) { const np = prompt(`Nh·∫≠p m·∫≠t kh·∫©u m·ªõi cho ng∆∞·ªùi d√πng "${username}":\n(√çt nh·∫•t 6 k√Ω t·ª±)`); if (np === null) return; if (np.length < 6) { showMessage("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.", "error"); return; } showConfirmationModalDialog( `B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªïi m·∫≠t kh·∫©u cho ng∆∞·ªùi d√πng "${username}"?`, async (c) => { if (c) { try { const res = await googleScriptRun('updateManagedUserPassword', username, np); showMessage(res.message, res.success ? 'success' : 'error'); if (res.success) loadUsers(); } catch (err) { showMessage(`L·ªói ƒë·ªïi m·∫≠t kh·∫©u: ${err.message || err.toString()}`, 'error'); } } }); }
        function promptForNewRole(username, currentRole) { const nr = prompt(`Nh·∫≠p vai tr√≤ m·ªõi cho ng∆∞·ªùi d√πng "${username}" (hi·ªán t·∫°i: ${currentRole}):\n(viewer, admin, superadmin)`, currentRole); if (nr === null) return; if (!['viewer', 'admin', 'superadmin'].includes(nr.toLowerCase())) { showMessage("Vai tr√≤ kh√¥ng h·ª£p l·ªá. Ch·ªâ ch·∫•p nh·∫≠n: viewer, admin, superadmin.", "error"); return; } showConfirmationModalDialog( `B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªïi vai tr√≤ cho ng∆∞·ªùi d√πng "${username}" th√†nh "${nr}"?`, async (c) => { if (c) { try { const res = await googleScriptRun('updateManagedUserRole', username, nr.toLowerCase()); showMessage(res.message, res.success ? 'success' : 'error'); if (res.success) loadUsers(); } catch (err) { showMessage(`L·ªói ƒë·ªïi vai tr√≤: ${err.message || err.toString()}`, 'error'); } } }); }
        async function deleteUserAction(username) { try { const res = await googleScriptRun('deleteManagedUser', username); showMessage(res.message, res.success ? 'success' : 'error'); if (res.success) loadUsers(); } catch (err) { showMessage(`L·ªói x√≥a ng∆∞·ªùi d√πng: ${err.message || err.toString()}`, 'error'); } }

        // --- Authentication & Initial Application Load ---
        loginButton.addEventListener('click', async () => { const u=usernameInput.value.trim(); const p=passwordInput.value; if(!u||!p){showMessage("Nh·∫≠p t√™n v√† m·∫≠t kh·∫©u.","error");return;} showLoginSpinner(); try { const res=await googleScriptRun('authenticateUser',u,p); showLoginSpinner(false); if(res.success){currentUserRole=res.role; currentUserDisplay.textContent=`Xin ch√†o, ${u} (${currentUserRole})`; loginPage.classList.add('hidden'); appPage.classList.remove('hidden'); updateUIForRole(); switchTab('vehicles'); if (rememberMeCheckbox.checked) { localStorage.setItem('rememberedUsername', u); } else { localStorage.removeItem('rememberedUsername'); } }else{showMessage(res.message,'error');}}catch(e){showLoginSpinner(false);showMessage(`L·ªói ƒëƒÉng nh·∫≠p: ${e.message||e}`,'error');}});
        logoutButton.addEventListener('click', async () => { try { await googleScriptRun('logoutUserOnServer'); } catch (e) { console.error("L·ªói g·ªçi logoutUserOnServer:", e); } currentUserRole=null; currentEditingChassisNumberVehicle=null; currentEditingChassisNumberOrder=null; usernameInput.value=''; if(!rememberMeCheckbox.checked) { usernameInput.value = ''; } passwordInput.value=''; appPage.classList.add('hidden'); loginPage.classList.remove('hidden'); generatedDocLinkContainer.innerHTML=''; showMessage("ƒê√£ ƒëƒÉng xu·∫•t.");});
        Object.keys(tabs).forEach(k => { if(tabs[k]&&tabs[k].button)tabs[k].button.addEventListener('click',()=>switchTab(k));});

        document.addEventListener('DOMContentLoaded', () => {
            const rememberedUser = localStorage.getItem('rememberedUsername');
            if (rememberedUser) {
                usernameInput.value = rememberedUser;
                rememberMeCheckbox.checked = true;
            }
            loginPage.classList.remove('hidden');
            appPage.classList.add('hidden');
        });
        
        // --- Autocomplete and Filter Functions ---
        orderChassisNumberInput.addEventListener('input', () => { const query = orderChassisNumberInput.value.toLowerCase(); chassisAutocompleteSuggestions.innerHTML = ''; if (query.length === 0) { chassisAutocompleteSuggestions.classList.add('hidden'); return; } const filteredVehicles = allAvailableVehicles.filter(v => v["S·ªë Khung"].toLowerCase().includes(query)); if (filteredVehicles.length > 0) { filteredVehicles.forEach(vehicle => { const item = document.createElement('div'); item.textContent = `${vehicle["S·ªë Khung"]} - ${vehicle["T√™n Xe"]} (${vehicle["Tr·∫°ng Th√°i Xe"]})`; item.classList.add('autocomplete-item'); item.addEventListener('click', () => { orderChassisNumberInput.value = vehicle["S·ªë Khung"]; chassisAutocompleteSuggestions.classList.add('hidden'); }); chassisAutocompleteSuggestions.appendChild(item); }); chassisAutocompleteSuggestions.classList.remove('hidden'); } else { chassisAutocompleteSuggestions.classList.add('hidden'); }});
        document.addEventListener('click', (e) => { if (!el('orderChassisNumberInput').contains(e.target)) { chassisAutocompleteSuggestions.classList.add('hidden'); }});
        function filterVehiclesTable() { const cf=filterChassisNumberInput.value.toLowerCase(),nf=filterVehicleNameInput.value.toLowerCase(),clf=filterVehicleColorInput.value.toLowerCase(),yf=filterManYearInput.value.toLowerCase(),cocf=filterCocInput.value.toLowerCase(),sf=filterVehicleStatusSelect.value.toLowerCase(),aif=filterActualInventorySelect.value.toLowerCase(); const rs=vehiclesTableBody.getElementsByTagName('tr'); let vr=0; for (let i=0;i<rs.length;i++) { const r=rs[i],c=r.getElementsByTagName('td'); if(c.length>7){ const ct=c[0]?c[0].textContent.toLowerCase():'',nt=c[1]?c[1].textContent.toLowerCase():'',clt=c[2]?c[2].textContent.toLowerCase():'',yt=c[3]?c[3].textContent.toLowerCase():'',coct=c[4]?c[4].textContent.toLowerCase():'',ss=c[6]?c[6].querySelector('.status-badge'):null,st=ss?ss.textContent.toLowerCase():'',ais=c[7]?c[7].querySelector('.status-badge'):null,ait=ais?ais.textContent.toLowerCase():''; const cm=ct.includes(cf),nm=nt.includes(nf),clm=clt.includes(clf),ym=yt.includes(yf),cocm=coct.includes(cocf),sm=sf===""||st===sf,aim=aif===""||ait===aif; if(cm&&nm&&clm&&ym&&cocm&&sm&&aim){r.style.display="";vr++;}else{r.style.display="none";}} } if(vr===0&&rs.length>0){noVehiclesMessage.textContent="Kh√¥ng t√¨m th·∫•y xe n√†o kh·ªõp v·ªõi b·ªô l·ªçc."; noVehiclesMessage.classList.remove('hidden');} else if(rs.length===0&&!noVehiclesMessage.classList.contains('hidden')){noVehiclesMessage.textContent="Kh√¥ng c√≥ xe n√†o trong kho.";} else if(vr>0){noVehiclesMessage.classList.add('hidden');}}
        if(filterChassisNumberInput) filterChassisNumberInput.addEventListener('input', filterVehiclesTable); if(filterVehicleNameInput) filterVehicleNameInput.addEventListener('input', filterVehiclesTable); if(filterVehicleColorInput) filterVehicleColorInput.addEventListener('input', filterVehiclesTable); if(filterManYearInput) filterManYearInput.addEventListener('input', filterVehiclesTable); if(filterCocInput) filterCocInput.addEventListener('input', filterVehiclesTable); if(filterVehicleStatusSelect) filterVehicleStatusSelect.addEventListener('change', filterVehiclesTable); if(filterActualInventorySelect) filterActualInventorySelect.addEventListener('change', filterVehiclesTable);
        if(clearVehicleFiltersButton) { clearVehicleFiltersButton.addEventListener('click', () => { if(filterChassisNumberInput) filterChassisNumberInput.value = ''; if(filterVehicleNameInput) filterVehicleNameInput.value = ''; if(filterVehicleColorInput) filterVehicleColorInput.value = ''; if(filterManYearInput) filterManYearInput.value = ''; if(filterCocInput) filterCocInput.value = ''; if(filterVehicleStatusSelect) filterVehicleStatusSelect.value = ''; if(filterActualInventorySelect) filterActualInventorySelect.value = ''; filterVehiclesTable(); });}
    </script>
</body>
</html>
